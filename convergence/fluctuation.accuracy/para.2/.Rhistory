remove(list = ls())
NUM_CLUSTERS <- 2
NO.TOP.CIRCUITS <- 10
NO.REPEATS <- 2 #1000
library(igraph)
library(NetAct)
library(sRACIPE)
source('../../../networks/functions.R')
source('../../../networks/heatmapSimilarity.updated.R')
library(dplyr)
outdir <- './results/'
dir.create(outdir)
datadir <- '../../rankings.allCircuits/results/'
circuit_metrics.sim <- read.csv(file = paste0(datadir , "./summary.circuits.sim.sortedByAcc_flex.csv"), row.names = 1)
circuit_metrics.sim <- circuit_metrics.sim[1:NO.TOP.CIRCUITS, ]
coreTFs.list <- readRDS('../../../tfSets/data/coreTFs.rds')
names(coreTFs.list)
targetDB.list <- readRDS('../../../databases/targetDB.list.rds')
names(targetDB.list)
fname.eset.brain_array <- '../../../data.tfs/eset.brain_array.rda'
load(fname.eset.brain_array) # loads object eset.brain_array
fname.de.results <- '../../../data.tfs/de.results.rda'
load(fname.de.results) # loads object de.results
tmp <- read.csv(file = paste0('../../../networks/circuits/', 'clusterCut.REF.csv'), row.names = 1)
clusterCut.REF <- as.integer(tmp$x)
names(clusterCut.REF) <- as.character(rownames(tmp))
accuracy.df <- as.data.frame(matrix(nrow = nrow(circuit_metrics.sim), ncol = NO.REPEATS))
rownames(accuracy.df) <- rownames(circuit_metrics.sim)
accuracy.list <- list()
library(doParallel)
library(foreach)
NO_AVAILABLE_CORES <- detectCores()
print(NO_AVAILABLE_CORES)
cl <- makeCluster(NO_AVAILABLE_CORES)
class(cl)
registerDoParallel(cl)
getDoParWorkers()
set.seed(1)
stopCluster(cl)
library(doParallel)
library(foreach)
NO_AVAILABLE_CORES <- detectCores()
print(NO_AVAILABLE_CORES)
cl <- makeCluster(NO_AVAILABLE_CORES)
cl <- makeCluster(NO_AVAILABLE_CORES)
?makeCluster
cl <- makeCluster(NO_AVAILABLE_CORES, setup_strategy = "sequential")
class(cl)
registerDoParallel(cl)
getDoParWorkers()
set.seed(1)
rv = foreach(circuit_idx = rownames(circuit_metrics.sim), .inorder = TRUE) %dopar% {
library(sRACIPE)
library(NetAct)
fr <- strsplit(circuit_idx, split = '-')[[1]][1]
top.TFs.count <- strsplit(circuit_idx, split = '-')[[1]][2]
#coreTFs <- coreTFs.list[[top.TFs.count]]
coreTFs <- coreTFs.list[[fr]][[top.TFs.count]][['COMB']]
targetDB = targetDB.list[[fr]]
length(coreTFs)
coreTFs <- intersect(coreTFs, names(targetDB))
length(coreTFs)
a = TF_Activity(tfs = coreTFs,
GSDB = targetDB,
eset = eset.brain_array,
DErslt = de.results  #DErslt=de.results$Overall
)
data.REF <- a$all_activities
# obtain simulated data:
racipe <- readRDS(file = paste('../../../networks/circuits.sim/circuit_simulated_',
circuit_idx, '.rds', sep = ''))
racipe <- sracipeNormalize(racipe)
data.sim <- assay(racipe,1)
# calculate similarity between activitites and racipe simulation data:
# acc.v <- vector(mode = 'numeric', length = NO.REPEATS)
# for(i in 1:NO.REPEATS){
#   print(i)
#   hS <- sracipeHeatmapSimilarity(dataReference = data.REF,
#                                  dataSimulation = data.sim,
#                                  returnData = T,
#                                  #nClusters = NUM_CLUSTERS,
#                                  clusterCut = clusterCut.REF)
#   acc.v[i] <-(hS$simulated.cluster.freq[2] + hS$simulated.cluster.freq[3])
# }
# write.csv(acc.v, file = paste(outdir, "./accuracy-", circuit_idx,".csv", sep = ''),
#           row.names = T, quote = F)
#
# accuracy.df[circuit_idx,] <- acc.v
# accuracy.list[[circuit_idx]] <- acc.v
#break()
accuracy.df[circuit_idx,] <- sapply(seq(1,NO.REPEATS),
function(x){
hS <- sracipeHeatmapSimilarity(dataReference = data.REF,
dataSimulation = data.sim,
returnData = T,
#nClusters = NUM_CLUSTERS,
clusterCut = clusterCut.REF)
return(hS$simulated.cluster.freq[2] + hS$simulated.cluster.freq[3])
}
)
write.csv(accuracy.df, file = paste(outdir, "./accuracy-", circuit_idx,".csv", sep = ''),
row.names = T, quote = F)
}
View(accuracy.df)
View(accuracy.df)
rev
class(rev())
class(rev)
rv
rv
class(rv)
?foreach
rv = foreach(circuit_idx = rownames(circuit_metrics.sim), .inorder = TRUE, .combine = 'rbind') %dopar% {
library(sRACIPE)
library(NetAct)
fr <- strsplit(circuit_idx, split = '-')[[1]][1]
top.TFs.count <- strsplit(circuit_idx, split = '-')[[1]][2]
#coreTFs <- coreTFs.list[[top.TFs.count]]
coreTFs <- coreTFs.list[[fr]][[top.TFs.count]][['COMB']]
targetDB = targetDB.list[[fr]]
length(coreTFs)
coreTFs <- intersect(coreTFs, names(targetDB))
length(coreTFs)
a = TF_Activity(tfs = coreTFs,
GSDB = targetDB,
eset = eset.brain_array,
DErslt = de.results  #DErslt=de.results$Overall
)
data.REF <- a$all_activities
# obtain simulated data:
racipe <- readRDS(file = paste('../../../networks/circuits.sim/circuit_simulated_',
circuit_idx, '.rds', sep = ''))
racipe <- sracipeNormalize(racipe)
data.sim <- assay(racipe,1)
# calculate similarity between activitites and racipe simulation data:
# acc.v <- vector(mode = 'numeric', length = NO.REPEATS)
# for(i in 1:NO.REPEATS){
#   print(i)
#   hS <- sracipeHeatmapSimilarity(dataReference = data.REF,
#                                  dataSimulation = data.sim,
#                                  returnData = T,
#                                  #nClusters = NUM_CLUSTERS,
#                                  clusterCut = clusterCut.REF)
#   acc.v[i] <-(hS$simulated.cluster.freq[2] + hS$simulated.cluster.freq[3])
# }
# write.csv(acc.v, file = paste(outdir, "./accuracy-", circuit_idx,".csv", sep = ''),
#           row.names = T, quote = F)
#
# accuracy.df[circuit_idx,] <- acc.v
# accuracy.list[[circuit_idx]] <- acc.v
#break()
accuracy.df[circuit_idx,] <- sapply(seq(1,NO.REPEATS),
function(x){
hS <- sracipeHeatmapSimilarity(dataReference = data.REF,
dataSimulation = data.sim,
returnData = T,
#nClusters = NUM_CLUSTERS,
clusterCut = clusterCut.REF)
return(hS$simulated.cluster.freq[2] + hS$simulated.cluster.freq[3])
}
)
write.csv(accuracy.df, file = paste(outdir, "./accuracy-", circuit_idx,".csv", sep = ''),
row.names = T, quote = F)
}
View(accuracy.df)
class(rename_vars())
rv
rv
class(rv)
rv
rv = foreach(circuit_idx = rownames(circuit_metrics.sim), .combine = 'rbind', .inorder = TRUE) %dopar% {
library(sRACIPE)
library(NetAct)
fr <- strsplit(circuit_idx, split = '-')[[1]][1]
top.TFs.count <- strsplit(circuit_idx, split = '-')[[1]][2]
#coreTFs <- coreTFs.list[[top.TFs.count]]
coreTFs <- coreTFs.list[[fr]][[top.TFs.count]][['COMB']]
targetDB = targetDB.list[[fr]]
length(coreTFs)
coreTFs <- intersect(coreTFs, names(targetDB))
length(coreTFs)
a = TF_Activity(tfs = coreTFs,
GSDB = targetDB,
eset = eset.brain_array,
DErslt = de.results  #DErslt=de.results$Overall
)
data.REF <- a$all_activities
# obtain simulated data:
racipe <- readRDS(file = paste('../../../networks/circuits.sim/circuit_simulated_',
circuit_idx, '.rds', sep = ''))
racipe <- sracipeNormalize(racipe)
data.sim <- assay(racipe,1)
# calculate similarity between activitites and racipe simulation data:
# acc.v <- vector(mode = 'numeric', length = NO.REPEATS)
# for(i in 1:NO.REPEATS){
#   print(i)
#   hS <- sracipeHeatmapSimilarity(dataReference = data.REF,
#                                  dataSimulation = data.sim,
#                                  returnData = T,
#                                  #nClusters = NUM_CLUSTERS,
#                                  clusterCut = clusterCut.REF)
#   acc.v[i] <-(hS$simulated.cluster.freq[2] + hS$simulated.cluster.freq[3])
# }
# write.csv(acc.v, file = paste(outdir, "./accuracy-", circuit_idx,".csv", sep = ''),
#           row.names = T, quote = F)
#
# accuracy.df[circuit_idx,] <- acc.v
# accuracy.list[[circuit_idx]] <- acc.v
#break()
acc.v <- sapply(seq(1,NO.REPEATS),
function(x){
hS <- sracipeHeatmapSimilarity(dataReference = data.REF,
dataSimulation = data.sim,
returnData = T,
#nClusters = NUM_CLUSTERS,
clusterCut = clusterCut.REF)
return(hS$simulated.cluster.freq[2] + hS$simulated.cluster.freq[3])
}
)
write.csv(acc.v, file = paste(outdir, "./accuracy-", circuit_idx,".csv", sep = ''),
row.names = T, quote = F)
accuracy.df[circuit_idx,] <- acc.v
}
View(accuracy.df)
View(rv)
class(rv)
rownames(rv) <- rownames(circuit_metrics.sim)
View(accuracy.df)
stopCluster(cl)
class(rv)
rownames(rv)
library(doParallel)
library(foreach)
NO_AVAILABLE_CORES <- detectCores()
print(NO_AVAILABLE_CORES)
cl <- makeCluster(NO_AVAILABLE_CORES, setup_strategy = "sequential")
class(cl)
registerDoParallel(cl)
getDoParWorkers()
set.seed(1)
rv = foreach(circuit_idx = rownames(circuit_metrics.sim), .combine = 'rbind', .inorder = TRUE) %dopar% {
library(sRACIPE)
library(NetAct)
fr <- strsplit(circuit_idx, split = '-')[[1]][1]
top.TFs.count <- strsplit(circuit_idx, split = '-')[[1]][2]
#coreTFs <- coreTFs.list[[top.TFs.count]]
coreTFs <- coreTFs.list[[fr]][[top.TFs.count]][['COMB']]
targetDB = targetDB.list[[fr]]
length(coreTFs)
coreTFs <- intersect(coreTFs, names(targetDB))
length(coreTFs)
a = TF_Activity(tfs = coreTFs,
GSDB = targetDB,
eset = eset.brain_array,
DErslt = de.results  #DErslt=de.results$Overall
)
data.REF <- a$all_activities
# obtain simulated data:
racipe <- readRDS(file = paste('../../../networks/circuits.sim/circuit_simulated_',
circuit_idx, '.rds', sep = ''))
racipe <- sracipeNormalize(racipe)
data.sim <- assay(racipe,1)
# calculate similarity between activitites and racipe simulation data:
acc.v <- sapply(seq(1,NO.REPEATS),
function(x){
hS <- sracipeHeatmapSimilarity(dataReference = data.REF,
dataSimulation = data.sim,
returnData = T,
#nClusters = NUM_CLUSTERS,
clusterCut = clusterCut.REF)
return(hS$simulated.cluster.freq[2] + hS$simulated.cluster.freq[3])
}
)
write.csv(acc.v, file = paste(outdir, "./accuracy-", circuit_idx,".csv", sep = ''),
row.names = T, quote = F)
acc.v
}
class(rv)
rownames(rv) <- rownames(circuit_metrics.sim)
View(rv)
write.csv(rv, file = paste0(outdir, "./accuracy.all.csv"), row.names = T, quote = F, col.names = F)
colnames(rv) <- paste('V', seq(1,NO.REPEATS), sep = '')
View(rv)
write.csv(rv, file = paste0(outdir, "./accuracy.all.csv"), row.names = T, quote = F)
stopCluster(cl)
remove(list = ls())
NO.TOP.CIRCUITS <- 10
datadir <- '../rankings.allCircuits/results/'
datadir <- '../rankings.allCircuits/results/'
circuit_metrics.sim <- read.csv(file = paste0(datadir , "./summary.circuits.sim.sortedByAcc_flex.csv"), row.names = 1)
datadir <- '../../rankings.allCircuits/results/'
circuit_metrics.sim <- read.csv(file = paste0(datadir , "./summary.circuits.sim.sortedByAcc_flex.csv"), row.names = 1)
circuit_metrics.sim <- circuit_metrics.sim[1:NO.TOP.CIRCUITS, ]
fname <-'./results.para/accuracy.dist.csv'
accuracy.df <- read.csv(file = fname, row.names = 1)
fname <-'./results/accuracy.dist.csv'
accuracy.df <- read.csv(file = fname, row.names = 1)
fname <-'./results/accuracy.all.csv'
accuracy.df <- read.csv(file = fname, row.names = 1)
dim(accuracy.df)
View(accuracy.df)
idx <- rownames(accuracy.df)[1]
hist(unlist(accuracy.df[1,]), breaks = 50, main = idx)
abline(v = mean(unlist(accuracy.df[1,])), col="red", lwd=2, lty=1)
abline(v = circuit_metrics.sim[idx, "Accuracy"], col="red", lwd=2, lty=2)
figdir <- './figs/'
dir.create(figdir)
WIDTH <- 12 #8 #6
HEIGHT <- 6 #12
figname <- paste(figdir, 'hist.accuracies-', WIDTH, 'x', HEIGHT,'.pdf', sep = '')
pdf(file = figname, width = WIDTH, height = HEIGHT, paper = 'special')
par(mfrow = c(2, 5))
par(oma=c(3,3,3,3)) # b, l, t, r - all sides have 3 lines of space - outer margin
par(mar=c(1,1,4,1) + 0.1) # b, l, t, r - inner margin
xlimit <- c((min(accuracy.df)-0.01), c(max(accuracy.df)+0.01))
for(idx in rownames(accuracy.df)){
print(idx)
main.str <- paste(idx, ':', circuit_metrics.sim[idx, "Nodes"], sep = '')
hist(unlist(accuracy.df[idx,]), breaks = 50, main = main.str, xlim = xlimit)
abline(v = mean(unlist(accuracy.df[idx,])), col="red", lwd=2, lty=1)
abline(v = circuit_metrics.sim[idx, "Accuracy"], col="red", lwd=2, lty=2)
#break()
}
dev.off()
getwd()
